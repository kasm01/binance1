import os
import csv
import logging
from datetime import datetime
from typing import Any, Dict, Optional

try:
    import gspread
    from google.oauth2.service_account import Credentials
except Exception:
    gspread = None
    Credentials = None


class TradeJournal:
    """
    Close-event tabanlı journal.

    RiskManager.on_position_close -> TradeJournal.log_trade_from_close(...)
    CSV kolonları (header):
      timestamp,symbol,side,interval,entry_price,exit_price,qty,notional,pnl_usdt,pnl_pct,duration_min,reason,label_best_side,model_conf,
      bt_p_buy_raw,bt_p_buy_ema,bt_ema_alpha
    """

    def __init__(self, logger: Optional[logging.Logger] = None) -> None:
        self.logger = logger or logging.getLogger("system")

        self.csv_path = os.getenv("TRADE_JOURNAL_CSV_PATH", "logs/trade_journal.csv")
        csv_dir = os.path.dirname(self.csv_path) or "."
        os.makedirs(csv_dir, exist_ok=True)

        # Google Sheet opsiyonel
        self.gs_enabled = os.getenv("ENABLE_GSHEET_JOURNAL", "0") in ("1", "true", "True")
        self.gs_credentials_path = os.getenv("GSHEET_CREDENTIALS_PATH", "")
        self.gs_spreadsheet_id = os.getenv("GSHEET_TRADES_SHEET_ID", "")
        self.gs_worksheet_name = os.getenv("GSHEET_TRADES_WORKSHEET", "Trades")

        self.gs_client = None
        self.gs_sheet = None

        if self.gs_enabled:
            self._init_gsheet()

        self._ensure_csv_header()

    def _init_gsheet(self) -> None:
        if gspread is None or Credentials is None:
            self.logger.warning("[JOURNAL] gspread yok, gsheet kapalı.")
            self.gs_enabled = False
            return

        try:
            scopes = [
                "https://www.googleapis.com/auth/spreadsheets",
                "https://www.googleapis.com/auth/drive",
            ]
            creds = Credentials.from_service_account_file(self.gs_credentials_path, scopes=scopes)
            self.gs_client = gspread.authorize(creds)
            sh = self.gs_client.open_by_key(self.gs_spreadsheet_id)
            self.gs_sheet = sh.worksheet(self.gs_worksheet_name)
            self.logger.info("[JOURNAL] GSheet ready: %s/%s", self.gs_spreadsheet_id, self.gs_worksheet_name)
        except Exception as e:
            self.logger.warning("[JOURNAL] GSheet init hata: %s", e)
            self.gs_enabled = False
            self.gs_client = None
            self.gs_sheet = None

    def _header(self) -> list[str]:
        return [
            "timestamp",
            "symbol",
            "side",
            "interval",
            "entry_price",
            "exit_price",
            "qty",
            "notional",
            "pnl_usdt",
            "pnl_pct",
            "duration_min",
            "reason",
            "label_best_side",
            "model_conf",
            "bt_p_buy_raw",
            "bt_p_buy_ema",
            "bt_ema_alpha",
        ]

    def _ensure_csv_header(self) -> None:
        if os.path.isfile(self.csv_path) and os.path.getsize(self.csv_path) > 0:
            return

        with open(self.csv_path, "w", newline="", encoding="utf-8") as f:
            w = csv.writer(f)
            w.writerow(self._header())

    def _append_csv_row(self, row: Dict[str, Any]) -> None:
        with open(self.csv_path, "a", newline="", encoding="utf-8") as f:
            w = csv.DictWriter(f, fieldnames=self._header(), extrasaction="ignore")
            w.writerow(row)

    def log_trade_from_close(
        self,
        symbol: str,
        exit_price: float,
        pnl_usdt: float,
        meta: Optional[Dict[str, Any]] = None,
    ) -> None:
        """
        Kapanış anında tek satır log.
        meta beklenen alanlar:
          - closed_side (long/short)
          - interval
          - entry_price
          - opened_at (iso str)  -> duration hesaplamak için
          - qty, notional
          - reason
          - label_best_side, model_conf
          - bt_p_buy_raw, bt_p_buy_ema, bt_ema_alpha  (flatten)
        """
        meta = meta or {}

        try:
            self.logger.info("[JOURNAL][DEBUG] meta keys=%s", sorted(list(meta.keys())) if isinstance(meta, dict) else type(meta))
        except Exception:
            pass

        side = str(meta.get("closed_side") or meta.get("side") or "").lower() or "unknown"
        interval = str(meta.get("interval") or "")
        entry_price = meta.get("entry_price")

        qty = meta.get("qty")
        notional = meta.get("notional")
        reason = meta.get("reason", "")

        label_best_side = meta.get("label_best_side", "")
        model_conf = meta.get("model_conf", "")

        bt_p_buy_raw = meta.get("bt_p_buy_raw")
        bt_p_buy_ema = meta.get("bt_p_buy_ema")
        bt_ema_alpha = meta.get("bt_ema_alpha")

        # pnl_pct
        pnl_pct = None
        try:
            if entry_price is not None and float(entry_price) != 0:
                # yön bağımsız: kapanış pnl_usdt / notional approx yerine entry bazlı basit oran
                pnl_pct = float(pnl_usdt) / (abs(float(notional)) if notional not in (None, 0) else 1.0)
        except Exception:
            pnl_pct = None

        # duration
        duration_min = None
        opened_at = meta.get("opened_at")
        try:
            if opened_at:
                t0 = datetime.fromisoformat(str(opened_at).replace("Z", ""))
                t1 = datetime.utcnow()
                duration_min = (t1 - t0).total_seconds() / 60.0
        except Exception:
            duration_min = None

        row = {
            "timestamp": datetime.utcnow().isoformat(),
            "symbol": symbol,
            "side": side,
            "interval": interval,
            "entry_price": float(entry_price) if entry_price is not None else None,
            "exit_price": float(exit_price),
            "qty": float(qty) if qty is not None else None,
            "notional": float(notional) if notional is not None else None,
            "pnl_usdt": float(pnl_usdt),
            "pnl_pct": float(pnl_pct) if pnl_pct is not None else None,
            "duration_min": float(duration_min) if duration_min is not None else None,
            "reason": reason,
            "label_best_side": label_best_side,
            "model_conf": model_conf,
            "bt_p_buy_raw": float(bt_p_buy_raw) if bt_p_buy_raw is not None else None,
            "bt_p_buy_ema": float(bt_p_buy_ema) if bt_p_buy_ema is not None else None,
            "bt_ema_alpha": float(bt_ema_alpha) if bt_ema_alpha is not None else None,
        }

        try:
            self._append_csv_row(row)
        except Exception as e:
            self.logger.warning("[JOURNAL] CSV append hata: %s", e)

        # opsiyonel: gsheet
        if self.gs_enabled and self.gs_sheet is not None:
            try:
                self.gs_sheet.append_row([row.get(k, "") for k in self._header()])
            except Exception as e:
                self.logger.warning("[JOURNAL] GSheet append hata: %s", e)
